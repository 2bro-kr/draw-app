<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>가중치 기반 추첨기</title>
<style>
	body {
		font-family: 'Segoe UI', sans-serif;
		background-color: #f9f9f9;
		padding: 20px;
		max-width: 600px;
		margin: auto;
		color: #333;
	}
	h2, h3 {
		color: #2c3e50;
	}
	input[type="text"] {
		width: 60%;
		padding: 8px;
		margin-right: 10px;
		border: 1px solid #ccc;
		border-radius: 4px;
	}
	button {
		margin: 5px 3px;
		padding: 8px 15px;
		border: none;
		border-radius: 4px;
		background-color: #3498db;
		color: white;
		cursor: pointer;
		transition: background-color 0.3s ease;
	}
	button:hover {
		background-color: #2980b9;
	}
	ul {
		list-style: none;
		padding-left: 0;
	}
	li {
		margin-bottom: 5px;
	}
	label {
		display: inline-block;
		margin-bottom: 5px;
	}
	select {
		padding: 6px;
		border-radius: 4px;
		margin-left: 10px;
	}
	.bar {
		height: 16px;
		background-color: #3498db;
		margin-bottom: 5px;
		border-radius: 4px;
	}
</style>
</head>
<body>
<h2>가중치 기반 추첨기</h2>
<input type="text" id="nameInput" placeholder="이름 입력">
<button onclick="addParticipant()">추가</button>
<ul id="participantList"></ul>
<hr>
<label for="winnerCount">당첨자 수:</label>
<select id="winnerCount"></select>
<br>
<button onclick="runDraw()">추첨 실행</button>
<h3>확률</h3>
<div id="probabilities"></div>
<h3>결과</h3>
<div id="result"></div>
<hr>
<h3>기록</h3>
<ul id="log"></ul>
<script>
let participants = JSON.parse(localStorage.getItem("participants")) || [];
let history = JSON.parse(localStorage.getItem("drawHistory")) || [];
let drawResult = null;

function playSound() {
	const audio = new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
	audio.play();
}

function saveParticipants() {
	localStorage.setItem("participants", JSON.stringify(participants));
	localStorage.setItem("drawHistory", JSON.stringify(history));
	drawResult = null;
	function editParticipant(index) {
	const newName = prompt("새 이름을 입력하세요:", participants[index].name);
	if (newName && newName.trim()) {
		participants[index].name = newName.trim();
		saveParticipants();
	}
}

function deleteParticipant(index) {
	if (confirm("정말 삭제하시겠습니까?")) {
		participants.splice(index, 1);
		saveParticipants();
	}
}

displayParticipants();
	updateWinnerCountOptions();
}

function addParticipant() {
	const name = document.getElementById("nameInput").value.trim();
	if (!name) return;
	if (!participants.find(p => p.name === name)) {
		participants.push({ name: name, count: 0, checked: true });
		saveParticipants();
	}
	document.getElementById("nameInput").value = "";
}

function displayParticipants() {
	const list = document.getElementById("participantList");
	list.innerHTML = "";
	participants.forEach((p, i) => {
		const li = document.createElement("li");
		li.innerHTML = `<input type="checkbox" ${p.checked ? "checked" : ""} onchange="toggleCheck(${i})"> 
		<span onclick="editParticipant(${i})" style="cursor:pointer;">${p.name}</span> (당첨 ${p.count}회)
		<button onclick="deleteParticipant(${i})">삭제</button>`;
		list.appendChild(li);
	});
	updateWinnerCountOptions();
	calculateProbabilities();
}

function toggleCheck(index) {
	participants[index].checked = !participants[index].checked;
	saveParticipants();
	calculateProbabilities();
}

function updateWinnerCountOptions() {
	const select = document.getElementById("winnerCount");
	const activeCount = participants.filter(p => p.checked).length;
	select.innerHTML = "";
	for (let i = 1; i <= activeCount; i++) {
		const opt = document.createElement("option");
		opt.value = i;
		opt.textContent = `${i}명`;
		select.appendChild(opt);
	}
}

function isThreeTimeStreak(name) {
	const recent = history.slice(-3).map(h => h.name);
	return recent.length === 3 && recent.every(n => n === name);
}

function calculateProbabilities() {
	const active = participants.filter(p => p.checked);
	if (active.length === 0) return;
	const filtered = active.filter(p => !isThreeTimeStreak(p.name));
	let weights = filtered.map(p => 1 / Math.sqrt(1 + p.count));
	let total = weights.reduce((a, b) => a + b, 0);
	let probs = filtered.map((p, i) => ({ name: p.name, prob: (weights[i] / total * 100).toFixed(2) }));
	let display = probs.map(p => `${p.name}: ${p.prob}%`);
	document.getElementById("probabilities").innerHTML = display.map(p => `<div>${p}</div>`).join("");
	drawResult = { probs: probs, weights: weights, active: filtered };
	document.getElementById("result").innerText = "";
}

function runDraw() {
	calculateProbabilities();
	if (!drawResult) return;
	const { active, weights } = drawResult;
	let count = parseInt(document.getElementById("winnerCount").value);
	let selected = [];
	let remaining = active.map((p, i) => ({ ...p, weight: weights[i] }));
	for (let c = 0; c < count && remaining.length > 0; c++) {
		let total = remaining.reduce((sum, p) => sum + p.weight, 0);
		let r = Math.random() * total;
		let acc = 0, index = -1;
		for (let i = 0; i < remaining.length; i++) {
			acc += remaining[i].weight;
			if (r < acc) {
				selected.push(remaining[i]);
				index = i;
				break;
			}
		}
		remaining.splice(index, 1);
	}
	drawResult.winners = selected;
	playSound();
	document.getElementById("result").innerHTML = selected.map(p => `당첨자: ${p.name}`).join("<br>");

	drawResult.winners.forEach(w => {
		const p = participants.find(p => p.name === w.name);
		if (p) p.count++;
		history.push({ name: w.name, time: new Date().toLocaleString() });
	});
	saveParticipants();
	displayLog();
	calculateProbabilities();
}

function displayLog() {
	const log = document.getElementById("log");
	log.innerHTML = "";
	history.forEach((entry, index) => {
		const li = document.createElement("li");
		li.innerHTML = `${entry.time} - ${entry.name} ` +
			`<button onclick="deleteLog(${index})">삭제</button>` +
			`<button onclick="editLog(${index})">수정</button>`;
		log.appendChild(li);
	});
}

function deleteLog(index) {
	const removed = history.splice(index, 1)[0];
	const p = participants.find(p => p.name === removed.name);
	if (p) p.count = Math.max(0, p.count - 1);
	saveParticipants();
	displayLog();
}

function editLog(index) {
	const newName = prompt("수정할 이름을 입력하세요:", history[index].name);
	if (!newName) return;
	const oldName = history[index].name;
	history[index].name = newName;
	const oldP = participants.find(p => p.name === oldName);
	if (oldP) oldP.count = Math.max(0, oldP.count - 1);
	let newP = participants.find(p => p.name === newName);
	if (!newP) {
		newP = { name: newName, count: 1, checked: true };
		participants.push(newP);
	} else {
		newP.count++;
	}
	saveParticipants();
	displayLog();
}

displayParticipants();
displayLog();
</script>
</body>
</html>
